<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Clasificación de Basura Inteligente</title>
    <style>
        /* Estilos generales */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Contenedor principal */
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #1c1e21;
            margin-bottom: 20px;
        }

        /* Layout principal (cámara e historial) */
        .main-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .camera-section, .history-section {
            flex: 1;
            min-width: 300px;
        }

        /* Sección de la cámara */
        .camera-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: #000;
            position: relative;
        }
        .camera-box img {
            width: 100%;
            display: block;
        }
        .camera-controls {
            padding: 15px;
            text-align: center;
        }

        /* Botón de captura */
        .capture-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .capture-btn:hover {
            background-color: #0056b3;
        }
        .capture-btn:active {
            transform: scale(0.98);
        }
        .capture-btn.loading {
            background-color: #555;
            cursor: not-allowed;
        }

        /* Sección del historial */
        .history-section h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .history-table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }

        /* Indicador de estado */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .status-enviado { background-color: #28a745; }
        .status-error_arduino { background-color: #dc3545; }
        .status-pendiente { background-color: #ffc107; color: #333; }
        .status-no_requerido { background-color: #6c757d; }

        /* Mensajes y notificaciones */
        .message-area {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            min-height: 20px;
            font-weight: bold;
        }
        .message-success { background-color: #e9f7ef; color: #28a745; }
        .message-error { background-color: #fdecea; color: #dc3545; }

    </style>
</head>
<body>

    <div class="container">
        <h1>🤖 Sistema de Clasificación de Basura Inteligente</h1>

        <div class="main-layout">
            <!-- Sección de la Cámara -->
            <div class="camera-section">
                <h2>Cámara en Vivo</h2>
                <div class="camera-box">
                    <img id="video-stream" src="{{ url_for('video_feed') }}" alt="Video en vivo">
                </div>
                <div class="camera-controls">
                    <button id="capture-btn" class="capture-btn">Clasificar Objeto</button>
                    <div id="message-area" class="message-area"></div>
                </div>
            </div>

            <!-- Sección del Historial -->
            <div class="history-section">
                <h2>Historial de Clasificación</h2>
                <div class="history-table-wrapper">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Material</th>
                                <th>Objeto Detectado</th>
                                <th>Estado Arduino</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Las filas se llenarán con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const captureBtn = document.getElementById('capture-btn');
            const messageArea = document.getElementById('message-area');
            const historyTableBody = document.querySelector('#history-table tbody');

            // --- Lógica de Captura y Clasificación ---
            captureBtn.addEventListener('click', async () => {
                if (captureBtn.classList.contains('loading')) return;

                setLoading(true, 'Clasificando, por favor espera...');

                try {
                    const response = await fetch('/capture', { method: 'POST' });
                    const result = await response.json();

                    if (response.ok) {
                        const material = result.classification.material || 'N/A';
                        showMessage(`¡Clasificado! Material: ${material.toUpperCase()}`, 'success');

                        // Leer la respuesta en voz alta
                        speak(result.classification.respuesta_hablada);
                    } else {
                        throw new Error(result.error || 'Ocurrió un error desconocido.');
                    }
                } catch (error) {
                    showMessage(`Error: ${error.message}`, 'error');
                } finally {
                    setLoading(false);
                    // Actualizar el historial después de cada captura
                    updateHistory();
                }
            });

            // --- Funciones Auxiliares ---
            function setLoading(isLoading, text = 'Clasificar Objeto') {
                captureBtn.disabled = isLoading;
                captureBtn.textContent = text;
                if (isLoading) {
                    captureBtn.classList.add('loading');
                } else {
                    captureBtn.classList.remove('loading');
                }
            }

            function showMessage(message, type) {
                messageArea.textContent = message;
                messageArea.className = `message-area message-${type}`;
            }

            function speak(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'es-ES'; // Configurar el idioma
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.warn('La API de Speech Synthesis no es compatible con este navegador.');
                }
            }

            // --- Lógica de Actualización del Historial ---
            async function updateHistory() {
                try {
                    const response = await fetch('/history');
                    const records = await response.json();

                    historyTableBody.innerHTML = ''; // Limpiar la tabla

                    records.forEach(record => {
                        const objetos = JSON.parse(record.objetos_detectados || '[]');
                        const primerObjeto = objetos.length > 0 ? objetos[0].nombre : 'N/A';

                        const row = `
                            <tr>
                                <td>${record.id}</td>
                                <td>${record.fecha}</td>
                                <td>${record.material || 'Nulo'}</td>
                                <td>${primerObjeto}</td>
                                <td><span class="status-badge status-${(record.estado_envio || '').toLowerCase()}">${record.estado_envio}</span></td>
                            </tr>
                        `;
                        historyTableBody.innerHTML += row;
                    });

                } catch (error) {
                    console.error('Error al actualizar el historial:', error);
                }
            }

            // Cargar el historial inicial y actualizarlo periódicamente
            updateHistory();
            setInterval(updateHistory, 10000); // Actualiza cada 10 segundos
        });
    </script>

</body>
</html>
